<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<style>
#results {
	display: none
}
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"
	integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
	crossorigin="anonymous">
        </script>
<script src="lib/N3.dist.js"></script>
<script src="lib/rdfa.dist.js"></script>
<script>
	function localName(node) {
		return node.id.substring(node.id.indexOf("#") + 1);
	}

    const { DataFactory } = N3;
    const { namedNode, blankNode, literal, defaultGraph, quad } = DataFactory;
    
    const prefixes = {
         xsd: 'http://www.w3.org/2001/XMLSchema#',
         rdf:'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
         fhir: 'http://hl7.org/fhir/', 
         niche: 'http://niche.cs.dal.ca/copd.n3#'
     };
    
    function insertData(valuePredicate, getCodeStmt) {
    	var valueStmts = store.getQuads(null, namedNode(valuePredicate), null);
			valueStmts.forEach((valueStmt, i) => {
				const codeStmt = getCodeStmt(valueStmt);
				
				var code = codeStmt.object.id;
				code = code.substring(code.indexOf("#") + 1);
				
				const element = $("#" + code);
				
				var value = "";	
				switch (element.attr('type')) {
				
				case 'number':
					value = element.val() * 1;
					break;
					
				case 'checkbox':
					value = element.is(':checked');
					break;
				}
					
				if (value !== "") {
					store.removeQuad(valueStmt);
					store.addQuad(valueStmt.subject, valueStmt.predicate, literal(value));
				}
			});
    }
    
    function insertValues(valuePredicate) {
    	insertData(valuePredicate, (valueStmt) => store.getQuads(valueStmt.subject, namedNode(prefixes.fhir + "Observation.code"), null)[0]);	
    }
    
    function insertQuantities(valuePredicate) {
    	insertData(valuePredicate, (valueStmt) => {
    		const quantityStmt = store.getQuads(null, null, valueStmt.subject)[0];
       			return store.getQuads(quantityStmt.subject, namedNode(prefixes.fhir + "Observation.code"), null)[0];		
    	});
    }
    
    function insertUserData() {
		insertValues(prefixes.fhir + "Observation.valueInteger");
        insertValues(prefixes.fhir + "Observation.valueBoolean");
        insertQuantities(prefixes.fhir + "Quantity.value");
        
        sendDiary();
    }
    
    function processDiary() {
        store = new N3.Store({ prefixes: prefixes });

        rdfaParser = new rdfa.RdfaParser({ contentType: 'text/html' })
          .on('data', (quad) => store.addQuad(quad))
          .on('error', console.error)
          .on('end', insertUserData);
    	
        $('#curDateTime').attr('content', new Date().toISOString());
        
        rdfaParser.write($("body").html());
        rdfaParser.end();
    }
    
    function sendDiary() {
    	const writer = new N3.Writer({ prefixes: prefixes });
    	store.forEach(stmt => writer.addQuad(stmt));
    	
    	writer.end((error, result) => {
        	// console.log(result);
        	
        	$.ajax({ 
        		url: "http://localhost:8080/cds_service/diary/",
        		type: "post",
        		data: result,
        		dataType: "text",
       			error: (xhr, status, error) => {
					console.log("error", xhr.responseText);
 				},
 				success: processResults
        	});
		});
    	
    	function processResults(data) {
    		$("#results").hide();
    		
    		//console.log(data);
    		
    		const store = new N3.Store({ prefixes: prefixes });
    		const parser = new N3.Parser({ format: 'N3' });
    		
    		// TODO no "end" event? 
    		// (found in StreamParser but don't want to use that)
    		// (currently relying on "null" quad being returned)
    		
    		//const quads = parser.parse(data);
    		//quads.forEach(quad => store.addQuad(quad));
    		
    		parser.parse(data, (error, quad, prefixes) => {
    			if (!error) {
    				if (quad != null)
    					store.addQuad(quad);
    				else
    					showResults(store);
    			}
    		});
    	}
    	
    	function showResults(store) {
    		$("#results").show();
    		
    		var conditions = [];
    		store.getQuads(null, namedNode(prefixes.rdf + "type"), namedNode(prefixes.fhir + "Condition")).forEach(stmt => {
    			const condition = stmt.subject;
    			
    			const code = store.getQuads(condition, namedNode(prefixes.fhir + "Condition.code"), null)[0].object;
    			const severity = store.getQuads(condition, namedNode(prefixes.fhir + "Condition.severity"), null)[0].object;
    			
    			const codeName = localName(code);
    			const severityName = localName(severity);

    			// console.log(codeName, severityName);
    			conditions.push("<li>" + codeName + " (" + severityName + ")</li>");
    		});
    		
    		// console.log(conditions);
    		if (conditions.length > 0)
    			$("#conditions").html("<ul>" + conditions.join("") + "</ul>");
    		else
    			$("#conditions").html("<i>none</i>");
    		
    		var zones = {};
    		store.getQuads(null, namedNode(prefixes.niche + "stratified"), null).forEach(stmt => {
    			const strat = stmt.object;
    			
    			const zone = store.getQuads(strat, namedNode(prefixes.niche + "zone"), null)[0].object;
    			const condition = store.getQuads(strat, namedNode(prefixes.niche + "condition"), null)[0].object;
    			
    			const code = store.getQuads(condition, namedNode(prefixes.fhir + "Condition.code"), null)[0].object;
    			const severity = store.getQuads(condition, namedNode(prefixes.fhir + "Condition.severity"), null)[0].object;
    			
    			const zoneName = localName(zone);
    			const codeName = localName(code);
    			const severityName = localName(severity);
    			
    			const str = "<li>" + codeName + " (" + severityName + ")</li>"
    			
    			// console.log(zoneName, codeName, severityName);
    			if (zones[zoneName])
    				zones[zoneName].push(str);
    			else
    				zones[zoneName] = [ str ];
    		});
    		
    		// console.log(zones);
    		
    		var str = "<ul>";
    		for (zone in zones) {
    			str += "<li>" + zone;
    			str += "<ul>" + zones[zone].join("") + "</ul>";
    			str += "</li>";
    		}
    		str += "</ul>";
    		
    		if (Object.keys(zones).length > 0)
    			$("#zones").html(str);
    		else
    			$("#zones").html("<i>empty</i>");
    	}
    } 
</script>
</head>
<body>
	<form action="" method="POST" onsubmit="processDiary(); return false">
		<h1>COPD observations</h1>
		<table
			prefix='niche: http://niche.cs.dal.ca/copd.n3# . fhir: http://hl7.org/fhir/'
			typeof='fhir:DiagnosticReport'>
			<tr style='display: none'>
				<td><span id='curDateTime'
					property='fhir:DiagnosticReport.effectiveDateTime'
					datatype='xsd:dateTime'></span> <span property='fhir:subject'
					typeof='fhir:Reference'> <span
						property='fhir:Reference.reference' resource='niche:patient0'></span>
				</span></td>
			</tr>
			<tr>
				<td>Is your cough, wheezing or stridor less, the same or worse
					than usual?</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_cough'></span> <input
					type='number' id='code_cough' min='1' max='10' step='1'
					property='fhir:Observation.valueInteger' /> (1-10, 1 is least, 5
					is same, 10 is worst)</td>
			</tr>
			<tr>
				<td>Is your amount of phlem, sputum or mucus, less, the same or
					worse than usual?</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_phlem_amount'></span>
					<input type='number' id='code_phlem_amount' min='1' max='10'
					step='1' property='fhir:Observation.valueInteger' /> (1-10, 1 is
					least, 5 is same, 10 is worst)</td>
			</tr>
			<tr>
				<td>Is the color of phlem, sputum or mucus green, yellow or
					rust-colored, and is this different from usual?</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_phlem_color'></span>
					<input type='checkbox' id='code_phlem_color'
					property='fhir:Observation.valueBoolean' /></td>
			</tr>
			<tr>
				<td>Is there significant blood in the phlem, sputum or mucus,
					beyond flecks or streaks?</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_phlem_blood'></span>
					<input type='checkbox' id='code_phlem_blood'
					property='fhir:Observation.valueBoolean' /></td>
			</tr>
			<tr>
				<td>Please rate your exertion level when performing activities.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_activity_exertion'></span>
					<input type='number' id='code_activity_exertion' min='1' max='10'
					step='1' property='fhir:Observation.valueInteger' /> (1-10, 1 is
					least, 5 is same, 10 is worst)</td>
			</tr>
			<tr>
				<td>Have you used your inhaler more often than usual?</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_use_inhaler'></span>
					<input type='checkbox' id='code_use_inhaler'
					property='fhir:Observation.valueBoolean' /></td>
			</tr>
			<tr>
				<td>Please indicate whether you have chest pain.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_chest_pain'></span> <input
					type='checkbox' id='code_chest_pain'
					property='fhir:Observation.valueBoolean' /></td>
			</tr>
			<tr>
				<td>Please indicate whether you have cyanosis (blue/grey
					coloration around lips, fingernails).</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_cyanosis'></span> <input
					type='checkbox' id='code_cyanosis'
					property='fhir:Observation.valueBoolean' /></td>
			</tr>
			<tr>
				<td>Please indicate whether you are feeling confused or have
					excessive drowsiness.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_confusion'></span> <input
					type='checkbox' id='code_confusion'
					property='fhir:Observation.valueBoolean' /></td>
			</tr>
			<tr>
				<td>Please indicate whether your ankles are swollen.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_swollen_ankle'></span>
					<input type='checkbox' id='code_swollen_ankle'
					property='fhir:Observation.valueBoolean' /></td>
			</tr>
			<tr>
				<td>Your objectively measured respiratory rate.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_rr'></span>
					<div property='fhir:Observation.valueQuantity'
						typeof='fhir:Quantity'>
						<span style='display: none' property='fhir:Quantity.system'
							resource='http://unitsofmeasure.org'></span> <span
							style='display: none' property='fhir:Quantity.code'>{Breaths}/min</span>
						<input type='number' id='code_rr' min='1' max='200' step='1'
							property='fhir:Quantity.value' /> breaths/min
					</div></td>
			</tr>
			<tr>
				<td>Your objectively measured heart rate.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_hr'></span>
					<div property='fhir:Observation.valueQuantity'
						typeof='fhir:Quantity'>
						<span style='display: none' property='fhir:Quantity.system'
							resource='http://unitsofmeasure.org'></span> <span
							style='display: none' property='fhir:Quantity.code'>{beats}/min</span>
						<input type='number' id='code_hr' min='1' max='400' step='1'
							property='fhir:Quantity.value' /> beats/min
					</div></td>
			</tr>
			<tr>
				<td>Your objectively measured O2 saturation.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_o2_sat'></span>
					<div property='fhir:Observation.valueQuantity'
						typeof='fhir:Quantity'>
						<span style='display: none' property='fhir:Quantity.system'
							resource='http://unitsofmeasure.org'></span> <span
							style='display: none' property='fhir:Quantity.code'>%</span> <input
							type='number' id='code_o2_sat' min='0' max='100' step='0.1'
							property='fhir:Quantity.value' /> %
					</div></td>
			</tr>
			<tr>
				<td>Your objectively measured body temperature.</td>
				<td property='fhir:DiagnosticReport.result'
					typeof='fhir:Observation'><span style='display: none'
					property='fhir:Observation.code'
					resource='http://niche.cs.dal.ca/copd.n3#code_body_temp'></span>
					<div property='fhir:Observation.valueQuantity'
						typeof='fhir:Quantity'>
						<span style='display: none' property='fhir:Quantity.system'
							resource='http://unitsofmeasure.org'></span> <span
							style='display: none' property='fhir:Quantity.code'>Cel</span> <input
							type='number' id='code_body_temp' min='0' max='100' step='0.1'
							property='fhir:Quantity.value' /> °C
					</div></td>
			</tr>
			<tr>
				<td><input type='submit' value='submit'></input></td>
			</tr>
		</table>
	</form>

	<div id="results">
		<h2>Stratifications</h2>
		<div id="zones"></div>

		<h2>All conditions</h2>
		<div id="conditions"></div>
	</div>

</body>
</html>